From 796ab8d9e6d3a6e8aca63819ce4ad31f6d85673b Mon Sep 17 00:00:00 2001
From: Alexandru Costache <alexandru@balena.io>
Date: Thu, 30 Jul 2020 00:02:07 +0200
Subject: [PATCH] dart-mx8mm: Integrate with Balena u-boot environment

And also switch back to loading kernel 4.14.78 dtbs

Upstream-Status: Inappropriate [configuration]
Signed-off-by: Alexandru Costache <alexandru@resin.io>
---
 configs/imx8mq_var_dart_defconfig |  8 ++++++++
 include/configs/imx8mq_var_dart.h | 23 +++++++++++++----------
 2 files changed, 21 insertions(+), 10 deletions(-)

diff --git a/configs/imx8mq_var_dart_defconfig b/configs/imx8mq_var_dart_defconfig
index f66c8b1791..cd5c2f49b5 100644
--- a/configs/imx8mq_var_dart_defconfig
+++ b/configs/imx8mq_var_dart_defconfig
@@ -59,3 +59,11 @@ CONFIG_USB_GADGET_DOWNLOAD=y
 CONFIG_FS_FAT=y
 CONFIG_NR_DRAM_BANKS=1
 # CONFIG_EFI_LOADER is not set
+CONFIG_CMD_EXPORTENV=y
+CONFIG_CMD_IMPORTENV=y
+CONFIG_PARTITION_UUIDS=y
+CONFIG_CMD_PART=y
+CONFIG_CMD_SETEXPR=y
+CONFIG_CMD_EXT2=y
+CONFIG_CMD_EXT4=y
+CONFIG_CMD_FAT=y
diff --git a/include/configs/imx8mq_var_dart.h b/include/configs/imx8mq_var_dart.h
index 138030c9a3..eef31af423 100644
--- a/include/configs/imx8mq_var_dart.h
+++ b/include/configs/imx8mq_var_dart.h
@@ -64,8 +64,6 @@
 #define CONFIG_BOARD_LATE_INIT
 
 /* Flat Device Tree Definitions */
-#undef CONFIG_CMD_EXPORTENV
-#undef CONFIG_CMD_IMPORTENV
 #undef CONFIG_CMD_IMLS
 
 #undef CONFIG_CMD_CRC32
@@ -128,11 +126,11 @@
 		"bootaux ${m4_addr};\0" \
 	"optargs=setenv bootargs ${bootargs} ${kernelargs};\0" \
 	"mmcargs=setenv bootargs console=${console} " \
-		"root=/dev/mmcblk${mmcblk}p${mmcpart} rootwait rw ${cma_size}\0" \
-	"loadbootscript=load mmc ${mmcdev}:${mmcpart} ${loadaddr} ${bootdir}/${script};\0" \
+               "${resin_kernel_root} rootwait rw ${cma_size} ${os_cmdline}\0" \
+       "loadbootscript=load mmc ${mmcdev}:${mmcpart} ${loadaddr}\0" \
 	"bootscript=echo Running bootscript from mmc ...; " \
 		"source\0" \
-	"loadimage=load mmc ${mmcdev}:${mmcpart} ${img_addr} ${bootdir}/${image};" \
+	"loadimage=load mmc ${mmcdev}:${resin_root_part} ${img_addr} boot/${image};" \
 		"unzip ${img_addr} ${loadaddr}\0" \
 	"ramsize_check="\
 		"if test $sdram_size -le 512; then " \
@@ -150,15 +148,15 @@
 		"fi;\0" \
 	"findfdt=" \
 		"if test $fdt_file = undefined; then " \
-			"if gpio input 12; then " \
-				"setenv fdt_file fsl-imx8mq-var-dart-cb12.dtb; " \
+		       "if test ${mmcdev} = 0; then " \
+                                "setenv fdt_file fsl-imx8mq-var-dart-emmc-wifi-hdmi.dtb; " \
 			"else " \
-				"setenv fdt_file fsl-imx8mq-var-dart.dtb;" \
+				"setenv fdt_file fsl-imx8mq-var-dart-sd-emmc-hdmi.dtb;" \
 			"fi; " \
 		"fi; \0" \
 	"loadfdt=run findfdt; " \
 		"echo fdt_file=${fdt_file}; " \
-		"load mmc ${mmcdev}:${mmcpart} ${fdt_addr} ${bootdir}/${fdt_file}\0" \
+                "load mmc ${mmcdev}:${resin_root_part} ${fdt_addr} boot/${fdt_file}\0" \
 	"mmcboot=echo Booting from mmc ...; " \
 		"run mmcargs; " \
 		"run optargs; " \
@@ -204,6 +202,11 @@
 
 #define CONFIG_BOOTCOMMAND \
 	   "run ramsize_check; " \
+           "setenv resin_kernel_load_addr ${loadaddr};" \
+           "run resin_set_kernel_root; run set_os_cmdline;" \
+           "setenv mmcdev ${resin_dev_index};" \
+           "setenv mmcbootpart ${resin_boot_part};" \
+           "gpio set 137; " \
 	   "mmc dev ${mmcdev}; if mmc rescan; then " \
 		   "if test ${use_m4} = yes && run loadm4bin; then " \
 			   "run runm4bin; " \
@@ -231,7 +234,7 @@
 
 #define CONFIG_ENV_OVERWRITE
 #define CONFIG_ENV_OFFSET		(64 * SZ_64K)
-#define CONFIG_ENV_SIZE			0x1000
+#define CONFIG_ENV_SIZE			0x3000
 #define CONFIG_SYS_MMC_ENV_DEV		1   /* USDHC2 */
 
 /* Size of malloc() pool */
-- 
2.17.1

